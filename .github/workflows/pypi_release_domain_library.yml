name: Prepare binary for pypi

on:
  pull_request:
    paths:
      - .github/workflows/pypi_release_domain_library.yml
  workflow_dispatch:
    inputs:
      domain:
        description: "What domain to prepare and remease"
        required: false
        type: choice
        default: torchao
        options:
          - torchao
          - executorch

jobs:
  trigger:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: pytorch/almalinux-builder:cpu
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Stage torchao binaries for release
        shell: bash
        run: |
            set -ex
            cd release/pypi
            # Install requirements
            pip install auditwheel
            LINUX_VERSION_SUFFIX="%2Bcu128"
            CPU_VERSION_SUFFIX="%2Bcpu"
            DRY_RUN=enabled
            TORCHAO_VERSION=0.13.0

            pwd
            upload_pypi_to_staging() {
              local package_name
              package_name=$1
              local promote_version
              promote_version=$2
              echo "=-=-=-= Promoting ${package_name}'s v${promote_version} to pypi staging' =-=-=-="
              (
                  set -x
                  PACKAGE_VERSION="${promote_version}" PACKAGE_NAME="${package_name}" DRY_RUN="${DRY_RUN}" bash ./upload_pypi_to_staging.sh
              )
              echo
            }
            PLATFORM="none-any" VERSION_SUFFIX="${CPU_VERSION_SUFFIX}" upload_pypi_to_staging torchao "${TORCHAO_VERSION}"
            PLATFORM="manylinux_2_28_x86_64" VERSION_SUFFIX="${LINUX_VERSION_SUFFIX}" ARCH="cu128" upload_pypi_to_staging torchao "${TORCHAO_VERSION}"
