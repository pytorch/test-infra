name: Update S3 HTML indices for download.pytorch.org

on:
  pull_request:
    paths:
      - .github/workflows/update-s3-html.yml
  schedule:
    # Update the indices every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch:


jobs:
  update:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        prefix: ["whl", "whl/test", "whl/nightly", "whl/lts/1.8"]
      fail-fast: False
    container:
      image: continuumio/miniconda3:23.10.0-1
    steps:
      - name: Checkout repository test-infra
        uses: actions/checkout@v3
        with:
          repository: pytorch/test-infra
          ref: ${{ github.ref }}
      - name: Update s3 html index
        shell: bash
        run: |
            set -ex

            # Create Conda Environment
            # conda create --quiet -y --prefix run_env python="3.8"
            # conda activate ./run_env

            # Install requirements
            pip install -r s3_management/requirements.txt
            python s3_management/manage.py --generate-pep503 ${{ matrix.prefix }}
