name: Release ecosystem library from test to production

on:
  pull_request:
    paths:
      - .github/workflows/release_library_download_pytorch_org.yml
  workflow_dispatch:
    inputs:
      domain:
        description: "Domain to prepare and release"
        required: false
        type: choice
        default: torchao
        options:
          - torchao

jobs:
  trigger:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: pytorch/almalinux-builder:cpu
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup AWS CLI
        uses: aws-actions/setup-aws-cli@v2
      - name: Promote library to download.pytorch.org
        shell: bash
        run: |
            set -ex
            cd release
            # Install requirements
            LINUX_VERSION_SUFFIX="%2Bcu128"
            CPU_VERSION_SUFFIX="%2Bcpu"
            DRY_RUN=enabled
            TORCHAO_VERSION=0.13.0

            pwd
            promote_s3() {
              local package_name
              package_name=$1
              local package_type
              package_type=$2
              local promote_version
              promote_version=$3

              echo "=-=-=-= Promoting ${package_name}'s v${promote_version} ${package_type} packages' =-=-=-="
              (
                  set -x
                  TEST_PYTORCH_PROMOTE_VERSION="${promote_version}" \
                      PACKAGE_NAME="${package_name}" \
                      PACKAGE_TYPE="${package_type}" \
                      TEST_WITHOUT_GIT_TAG=1 \
                      DRY_RUN="${DRY_RUN}" ./promote/s3_to_s3.sh
              )
              echo
            }

            promote_s3 "torchao" whl "${TORCHAO_VERSION}"
