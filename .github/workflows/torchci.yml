name: torchci
on:
  pull_request:
    paths:
      - 'torchci/**'
  push:
    branches:
      - main

defaults:
  run:
    working-directory: torchci

jobs:
  test:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install
        run: yarn install --frozen-lockfile
      - name: Lint
        run: yarn lint
      - name: Test
        run: yarn test

  check-rockset:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install
        run: yarn install --frozen-lockfile
      - name: Authorize rockset
        run: yarn run rockset auth add default ${{ secrets.ROCKSET_API_KEY }}
      - name: Download query lambdas
        run: yarn run rockset local download -y
      - name: Check for differences
        run: |
          git diff-index --quiet HEAD -- || (git diff; echo '::error::Diff between query lambdas in Rockset and in your local checkout, make sure they are in sync by either deploying your new code or downloading existing lambdas! See workflow log for diff.'; return 1)
