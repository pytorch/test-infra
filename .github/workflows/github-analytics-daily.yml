name: GitHub Analytics Daily

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  github-analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout test-infra
      uses: actions/checkout@v4

    - name: Checkout PyTorch repository
      uses: actions/checkout@v4
      with:
        repository: pytorch/pytorch
        path: pytorch
        fetch-depth: 0  # Need full history for analysis

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install any dependencies the script might need
        pip install requests tqdm

    - name: Run GitHub Analytics
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python tools/analytics/github_analyze.py \
          --repo-path ./pytorch \
          --remote upstream -- \
          --branch release/2.7 \
          --milestone-id 54 \
          --missing-in-branch


    - name: Upload analytics results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: github-analytics-results-${{ github.run_id }}
        path: |
          *.json
          *.csv
          *.log
        retention-days: 30
