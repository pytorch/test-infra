name: GitHub Analytics Daily

on:
  pull:
  	- .github/workflows/github-analytics-daily.yml
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      release:
        description: "PyTorch release branch. e.g. release/2.7"
        required: true
      milestone-id:
        description: 'Release milestone ID. e.g. 54'
        required: true


jobs:
  github-analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout test-infra
      uses: actions/checkout@v4

    - name: Checkout PyTorch repository
      uses: actions/checkout@v4
      with:
        repository: pytorch/pytorch
        path: pytorch
        fetch-depth: 0  # Need full history for analysis

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        set -eux
        python3 -m pip install --upgrade pip
        python3 -m pip install requests==2.31.0 tqdm==4.64.1

    - name: Run GitHub Analytics
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python3 tools/analytics/github_analyze.py \
          --repo-path ./pytorch \
          --remote upstream -- \
          --branch release/2.7 \
          --milestone-id 54 \
          --missing-in-branch


    - name: Upload analytics results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: github-analytics-results-${{ github.run_id }}
        path: |
          *.json
          *.csv
          *.log
        retention-days: 30
