name: Test build/test linux workflow

on:
  pull_request:
    paths:
      - .github/workflows/linux_job.yml
      - .github/workflows/test_linux_job.yml
  workflow_dispatch:

jobs:
  test-vision-cpu:
    uses: ./.github/workflows/linux_job.yml
    with:
      repository: pytorch/vision
      ref: main
      runner: linux.4xlarge
      test-infra-repository: ${{ github.repository }}
      test-infra-ref: ${{ github.ref }}
      gpu-arch-type: cpu
      gpu-arch-version: ""
      timeout: 60
      script: |
        export PATH="/opt/python/cp38-cp38/bin:${PATH}"
        export CU_VERSION=cpu
        export UPLOAD_CHANNEL=nightly
        .circleci/unittest/linux/scripts/setup_env.sh
        .circleci/unittest/linux/scripts/install.sh
        .circleci/unittest/linux/scripts/run_test.sh
  test-vision-gpu:
    uses: ./.github/workflows/linux_job.yml
    with:
      repository: pytorch/vision
      ref: main
      runner: linux.8xlarge.nvidia.gpu
      test-infra-repository: ${{ github.repository }}
      test-infra-ref: ${{ github.ref }}
      gpu-arch-type: cuda
      gpu-arch-version: "11.6"
      timeout: 60
      script: |
        export PATH="/opt/python/cp38-cp38/bin:${PATH}"
        export CU_VERSION=cu116
        export UPLOAD_CHANNEL=nightly
        .circleci/unittest/linux/scripts/setup_env.sh
        .circleci/unittest/linux/scripts/install.sh
        .circleci/unittest/linux/scripts/run_test.sh
