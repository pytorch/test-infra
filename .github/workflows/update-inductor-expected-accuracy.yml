name: Update Inductor Expected Accuracy

on:
  # Run weekly on Sunday at 3:00 AM UTC
  schedule:
    - cron: "0 3 * * 0"
  # Allow manual triggering with SHA parameter
  workflow_dispatch:
    inputs:
      pytorch_sha:
        description: 'PyTorch commit SHA to use for updating expected accuracy'
        required: true
        type: string

jobs:
  update-expected-accuracy:
    runs-on: ubuntu-latest
    environment: trigger-nightly
    steps:
      - name: Checkout PyTorch repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: pytorch/pytorch
          token: ${{ secrets.GH_PYTORCHBOT_TOKEN }}
          fetch-depth: 0

      - name: Set up Python 3.10
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pandas requests

      - name: Determine PyTorch SHA
        id: determine-sha
        run: |
          if [ -n "${{ github.event.inputs.pytorch_sha }}" ]; then
            SHA="${{ github.event.inputs.pytorch_sha }}"
          else
            # Use the latest commit SHA from main branch if not manually specified
            SHA=$(git rev-parse HEAD)
          fi
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "Using PyTorch SHA: ${SHA}"

      - name: Run update_expected.py
        env:
          CH_KEY_ID: ${{ secrets.CH_KEY_ID }}
          CH_KEY_SECRET: ${{ secrets.CH_KEY_SECRET }}
        run: |
          python benchmarks/dynamo/ci_expected_accuracy/update_expected.py ${{ steps.determine-sha.outputs.sha }}

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet benchmarks/dynamo/ci_expected_accuracy/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PYTORCHBOT_TOKEN }}
        run: |
          # Configure git
          git config user.name "pytorchbot"
          git config user.email "soumith+bot@pytorch.org"

          # Create a new branch
          BRANCH_NAME="update-inductor-expected-accuracy-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "${BRANCH_NAME}"

          # Add and commit changes
          git add benchmarks/dynamo/ci_expected_accuracy/
          git commit -m "$(cat <<'EOF'
          Update inductor expected accuracy files

          This PR updates the expected accuracy CSV files for inductor benchmarks
          based on CI results from commit ${{ steps.determine-sha.outputs.sha }}.

          These files are used as reference points for dynamo/inductor CI to detect
          regressions in graph breaks and accuracy.
          EOF
          )"

          # Push the branch
          git push -u origin "${BRANCH_NAME}"

          # Create pull request
          gh pr create \
            --title "Update inductor expected accuracy files" \
            --body "$(cat <<'EOF'
          ## Summary

          This PR updates the expected accuracy CSV files for inductor benchmarks based on CI results from PyTorch commit ${{ steps.determine-sha.outputs.sha }}.

          These files serve as reference points for dynamo/inductor CI to track:
          - Graph breaks
          - Model accuracy

          ## Changes

          - Updated CUDA expected accuracy files in `benchmarks/dynamo/ci_expected_accuracy/`
          - Updated ROCm expected accuracy files in `benchmarks/dynamo/ci_expected_accuracy/rocm/`

          ## Test Plan

          - [ ] Verify that the CI jobs pass with the updated expected accuracy files
          - [ ] Review the diff to ensure changes are reasonable and expected
          - [ ] Check that no unexpected regressions are being marked as "expected"

          cc: @pytorch/pytorch-dev-infra
          EOF
          )" \
            --base main \
            --head "${BRANCH_NAME}"

      - name: No changes to commit
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "No changes detected in expected accuracy files. Skipping PR creation."
