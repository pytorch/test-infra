name: Wait for SSH session on Linux

description: Stuff that should always run at the end of a linux job
# test
inputs:
  skip-wait-ssh:
    description: If set, don't wait for ssh to drain before tearing down
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Hold runner for 2 hours or until ssh sessions have drained
      # TODO working-directory: !{{ pytorch_directory }}
      # Always hold for active ssh sessions
      shell: bash
      if: inputs.skip-wait-ssh == ''
      run: |
        set -eou pipefail

        echo "Holding runner for 2 hours until all ssh sessions have logged out"
        for _ in $(seq 1440); do
            # Break if no ssh session exists anymore
            if [ "$(who)" = "" ]; then
              break
            fi
            echo "."
            sleep 5
        done
