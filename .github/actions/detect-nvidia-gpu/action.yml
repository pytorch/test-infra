name: Detect NVIDIA GPU

description: Detect availability of NVIDIA GPUs and whether the current runner is already inside a container.

outputs:
  has-nvidia:
    description: '"true" if at least one NVIDIA GPU is exposed to the runner.'
    value: ${{ steps.detect.outputs.HAS_NVIDIA }}
  detected-devices:
    description: Raw output describing the detected devices (if any).
    value: ${{ steps.detect.outputs.DETECTED_DEVICES }}
  in-container-runner:
    description: '"true" if the workflow is running inside a container runner (ARC, dind, etc.).'
    value: ${{ steps.check-container.outputs.IN_CONTAINER_RUNNER }}

runs:
  using: composite
  steps:
    - id: check-container
      name: Check if running inside container runner
      shell: bash
      run: |
        echo "IN_CONTAINER_RUNNER=$(if [ -f /.inarc ] || [ -f /.incontainer ]; then echo true ; else echo false; fi)" >> "$GITHUB_OUTPUT"

    - id: detect
      name: Detect NVIDIA GPU availability
      shell: bash
      run: |
        set -euo pipefail

        has_gpu=false
        devices=""

        if command -v nvidia-smi >/dev/null 2>&1; then
          if nvidia-smi -L >/tmp/nvidia_devices 2>/dev/null; then
            has_gpu=true
            devices=$(cat /tmp/nvidia_devices)
          fi
        fi

        if [ "$has_gpu" = false ]; then
          if ls /dev/nvidia* >/tmp/nvidia_devices 2>/dev/null; then
            has_gpu=true
            devices=$(cat /tmp/nvidia_devices)
          fi
        fi

        if [ "$has_gpu" = false ] && command -v lspci >/dev/null 2>&1; then
          if lspci | grep -i 'nvidia' >/tmp/nvidia_devices 2>/dev/null; then
            has_gpu=true
            devices=$(cat /tmp/nvidia_devices)
          fi
        fi

        printf 'HAS_NVIDIA=%s\n' "$has_gpu" >> "$GITHUB_OUTPUT"
        printf 'DETECTED_DEVICES<<EOF\n%s\nEOF\n' "$devices" >> "$GITHUB_OUTPUT"

