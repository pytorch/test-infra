---
- name: Setup Docker
  hosts: all
  become: true
  become_user: root
  become_method: sudo
  gather_facts: false
  json_data_source_ver: 1.3.1
  rockset_data_source_ver: 0.1.2
  tasks:
    - name: Setup
      # Note: The IP CIDR should be chosen carefully! Collisions with the host
      # network will make everything not work.
      shell: |
        apt update
        apt install -y docker.io
        apt install -y unzip
        docker swarm init --default-addr-pool 10.0.0.0/8 || echo done
        docker stack rm monitoring || echo done

        rm -rf /etc/pytorch
        mkdir -p \
          /etc/pytorch/grafana-provisioning/datasources \
          /etc/pytorch/grafana-provisioning/notifiers \
          /etc/pytorch/grafana-provisioning/dashboards \
          /etc/pytorch/dashboards/ \
          /etc/pytorch/grafana

        wget https://github.com/marcusolsson/grafana-json-datasource/releases/download/v{{json_data_source_ver}}/marcusolsson-json-datasource-{{json_data_source_ver}}.zip
        unzip marcusolsson-json-datasource-{{json_data_source_ver}}.zip -d /etc/pytorch/grafana/plugins
        rm marcusolsson-json-datasource-{{json_data_source_ver}}.zip

        wget https://rockset-public.s3-us-west-2.amazonaws.com/rockset-backend-datasource-{{rockset_data_source_ver}}.zip
        unzip rockset-backend-datasource-{{rockset_data_source_ver}}.zip -d /etc/pytorch/grafana/plugins
        rm rockset-backend-datasource-{{rockset_data_source_ver}}.zip

        find /etc/pytorch -type d | xargs chmod 777
    - name: Copy files
      template:
        src: "{{ item.src }}"
        dest: "/etc/pytorch/{{ item.path }}"
      with_filetree: files/
      when: item.state == 'file'
    - name: Run compose
      shell: |
        docker stack rm monitoring || echo done
        docker stack deploy -c /etc/pytorch/docker-compose.yml monitoring
